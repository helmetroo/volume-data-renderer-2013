/**
 * Samuel Sweet
 * CS 5610-1 Assignment 2
 *
 * Convenience methods for organizing all
 * shader programs (implementations).
 */

#include "shader.hpp"

// Static refs
unsigned int ShaderSystem::shader_id;
unsigned int ShaderSystem::shader_id_two;
unsigned int ShaderSystem::shader_id_three;
unsigned int ShaderSystem::shader_id_four;
unsigned int ShaderSystem::shader_id_five;

ShaderSystem::ShaderPrograms ShaderSystem::which_shader;
int ShaderSystem::which_shader_enum_val;

ShaderSystem::ShaderSystem()
{
  shader_id = 0;
  shader_vp = 0;
  shader_fp = 0;

  shader_id_two = 0;
  shader_vp_two = 0;
  shader_fp_two = 0;

  shader_id_three = 0;
  shader_vp_three = 0;
  shader_fp_three = 0;

  shader_id_four = 0;
  shader_vp_four = 0;
  shader_fp_four = 0;

  shader_id_five = 0;
  shader_vp_five = 0;
  shader_fp_five = 0;

  which_shader = PHONG;
  which_shader_enum_val = static_cast<int>(which_shader);
}

// Reads a shader file and returns a pointer to the
// char array representing it.
char* ShaderSystem::textFileRead(const char *fileName) 
{
  char* text = NULL;
	
  // Open the file to read only.
  if (fileName != NULL) {
    FILE *file = fopen(fileName, "rt");
	  
    if (file != NULL) {
      fseek(file, 0, SEEK_END);
      int count = ftell(file);
      rewind(file);
            
      if (count > 0) {
	text = (char*)malloc(sizeof(char) * (count + 1));
	count = fread(text, sizeof(char), count, file);
	text[count] = '\0';
      }
      fclose(file);
    }
  }

  return text;
}

// Checks compile/link information from a given shader program.
void ShaderSystem::validateShader(GLuint shader, const char* file) {
  const unsigned int BUFFER_SIZE = 512;
  char buffer[BUFFER_SIZE];
  memset(buffer, 0, BUFFER_SIZE);
  GLsizei length = 0;
    
  // Fill buffer with log data
  glGetShaderInfoLog(shader, BUFFER_SIZE, &length, buffer);
  if (length > 0)
    printf("Shader %i (%s) compile error: %s\n", shader, file, buffer);
}

// Checks for linker errors in a shader program.
void ShaderSystem::validateProgram(GLuint program, const char* vs_name, const char* fs_name) 
{
  const unsigned int BUFFER_SIZE = 512;
  char buffer[BUFFER_SIZE];
  memset(buffer, 0, BUFFER_SIZE);
  GLsizei length = 0;
  
  memset(buffer, 0, BUFFER_SIZE);
  glGetProgramInfoLog(program, BUFFER_SIZE, &length, buffer);
  if (length > 0)
    printf("Program %d link error: %s\n", program, buffer);
  
  glValidateProgram(program);
  GLint status;
  glGetProgramiv(program, GL_VALIDATE_STATUS, &status);
  if (status == GL_FALSE) {
    printf("Error validating shader %d, files read were %s and %s\n", program, vs_name, fs_name);
  }
}

// Begins reading vertex and fragment shader, and defines shader program.
void ShaderSystem::initShader(const char *vsFile, const char *fsFile, ShaderSystem::ShaderPrograms which) {
  // Pointers to our vars, so we only
  // change the ones we need
  unsigned int* which_vp;
  unsigned int* which_fp;
  unsigned int* which_shader_id;

  switch(which)
    {
    case PHONG:
      which_vp = &shader_vp;
      which_fp = &shader_fp;
      which_shader_id = &shader_id;
      break;
	 
    case PHONG_BUMP_FLOOR:
      which_vp = &shader_vp_two;
      which_fp = &shader_fp_two;
      which_shader_id = &shader_id_two;
      break;

    case PHONG_BUMP_BRICK:
      which_vp = &shader_vp_three;
      which_fp = &shader_fp_three;
      which_shader_id = &shader_id_three;
      break;

    case TOON:
      which_vp = &shader_vp_four;
      which_fp = &shader_fp_four;
      which_shader_id = &shader_id_four;
      break;

    case TOON_SILHOUETTE:
      which_vp = &shader_vp_five;
      which_fp = &shader_fp_five;
      which_shader_id = &shader_id_five;
      break;
	 
    default:
      return;
    }

  *which_vp = glCreateShader(GL_VERTEX_SHADER);
  *which_fp = glCreateShader(GL_FRAGMENT_SHADER);
  
  const char* vsText = this->textFileRead(vsFile);
  const char* fsText = this->textFileRead(fsFile);	
  
  // Errors? If so, print 'em
  if (vsText == NULL) perror("OOPS! Vertex shader couldn't be read.");
  if (fsText == NULL) perror("OOPS! Fragment shader couldn't be read.");
  if (vsText == NULL || fsText == NULL) return;
  
  glShaderSource(*which_vp, 1, &vsText, 0);
  glShaderSource(*which_fp, 1, &fsText, 0);
  
  glCompileShader(*which_vp);
  validateShader(*which_vp, vsFile);
  glCompileShader(*which_fp);
  validateShader(*which_fp, fsFile);
  
  *which_shader_id = glCreateProgram();
  glAttachShader(*which_shader_id, *which_fp);
  glAttachShader(*which_shader_id, *which_vp);
  glLinkProgram(*which_shader_id);
  validateProgram(*which_shader_id, vsFile, fsFile);
}

// Destroys both shader programs.
void ShaderSystem::destroyShader(void) 
{
  glDetachShader(shader_id, shader_fp);
  glDetachShader(shader_id, shader_vp);
    
  glDeleteShader(shader_fp);
  glDeleteShader(shader_vp);
  glDeleteProgram(shader_id);

  glDeleteShader(shader_fp_two);
  glDeleteShader(shader_vp_two);
  glDeleteProgram(shader_id_two);

  glDeleteShader(shader_fp_three);
  glDeleteShader(shader_vp_three);
  glDeleteProgram(shader_id_three);

  glDeleteShader(shader_fp_four);
  glDeleteShader(shader_vp_four);
  glDeleteProgram(shader_id_four);

  glDeleteShader(shader_fp_five);
  glDeleteShader(shader_vp_five);
  glDeleteProgram(shader_id_five);
}
